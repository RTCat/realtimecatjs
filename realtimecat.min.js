/*! realtimecat-client-js-sdk - v0.0.5 - 2015-09-12 */function startScreenStreamFrom(a){var b=RTCat.localScreenStream;RTCat.GetUserMedia.call(navigator,{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a,maxWidth:window.screen.width,maxHeight:window.screen.height}}},function(a){b.screen=!0,b.stream=a,b.emit("access-accepted")},function(a){b.emit("access-failed",a)})}var RTCat=RTCat||function(){};RTCat.PeerConnectioin=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,RTCat.SessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,RTCat.IceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,RTCat.GetUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,RTCat.URL=window.URL||window.webkitURL||window.msURL||window.oURL,RTCat.isMoz=!!navigator.mozGetUserMedia;var RTCat=RTCat||function(){};RTCat.Detect=function(){function a(){var a="track"in document.createElement("track"),b=window.chrome&&window.chrome.webstore?Object.keys(window.chrome.webstore).length:0,c=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,e="undefined"!=typeof InstallTrigger,p=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,q=!!window.chrome&&!c,r=!!document.documentMode,s=/QQBrowser/.test(navigator.userAgent),t=/MetaSr/.test(navigator.userAgent),u=d(/^liebao/i,0),v=!1,w=!1;return a&&(b>1||(w=!0)),s?k:u?n:t?o:p?h:e?i:c?j:v?m:w?l:r?f:q?g:0}function b(){switch(e.name){case 0:return 0;case f:if(/MSIE ([\d\.]+)/.test(navigator.userAgent))return parseInt(RegExp.$1);break;case g:if(/Chrome\/([\d]+)\./.test(navigator.userAgent))return parseInt(RegExp.$1);break;case h:if(/Version\/([\d\.]+)/.test(navigator.userAgent))return parseInt(RegExp.$1);break;case i:if(/Firefox\/([\d]+)\./.test(navigator.userAgent))return parseInt(RegExp.$1);break;case j:if(/OPR\/([\d]+)\./.test(navigator.userAgent))return parseInt(RegExp.$1);break;case k:if(/QQBrowser\/([\d]+)\./.test(navigator.userAgent))return parseInt(RegExp.$1);break;default:return 0}}function c(){var a={};if(RTCat.GetUserMedia&&(a.getUserMedia=!0),RTCat.PeerConnectioin&&(a.peerConnection=!0),a.peerConnection){var b=new RTCat.PeerConnectioin({iceServers:[{url:"stun:api.shishimao.com:3478"}]});b.createDataChannel&&(a.dataChannel=!0)}return a}function d(a,b){var c=window.external||{};for(var d in c)if(a.test(b?c[d]:d))return!0;return!1}var e=this,f=1,g=2,h=3,i=4,j=5,k=6,l=7,m=8,n=9,o=10;this.name=a(),this.version=b(),this.webrtc=c();var p=[g,j,k,l,m,o];this.isSupported=function(){for(var a in p)if(this.name==p[a])return!0;return!1},this.getInputDevices=function(a){try{var b=[];MediaStreamTrack.getSources(function(c){for(var d=0;d<c.length;d++){var e=c[d];b.push({type:e.kind,label:e.label,id:e.id})}a(null,b)})}catch(c){a(c)}},this.getBrowser=function(){var a;switch(this.name){case 0:a="unknown browser";break;case f:a="IE";break;case g:a="Chrome";break;case h:a="Safari";break;case i:a="Firefox";break;case j:a="Opera";break;case m:a="360极速浏览器";break;case l:a="360安全浏览器";break;case o:a="搜狗浏览器";break;case n:a="猎豹浏览器";break;case k:a="QQ浏览器";break;default:a="unknown browser"}return a},this.getVersion=function(){return this.version},this.WebRtcSupport=function(){return this.webrtc}};var RTCat=RTCat||{};RTCat.EventEmitter=function(){this.events={}},RTCat.EventEmitter.prototype.on=function(a,b){this.events[a]=[],this.events[a].push(b)},RTCat.EventEmitter.prototype.emit=function(a,b){var c,d,e=this.events[a],f=Array.prototype.slice.call(arguments,1);if(e)for(c=0,d=e.length;d>c;c++)e[c].apply(null,f)};var RTCat=RTCat||function(){};RTCat.extensionInstalled=!1,window.addEventListener("message",function(a){a.origin==window.location.origin&&(a.data.type&&"SS_PING"===a.data.type&&(RTCat.extensionInstalled=!0),a.data.type&&"SS_DIALOG_SUCCESS"===a.data.type&&startScreenStreamFrom(a.data.streamId),a.data.type&&"SS_DIALOG_CANCEL"===a.data.type&&RTCat.localScreenStream&&RTCat.localScreenStream.emit("access-failed","User cancelled!"))});var RTCat=RTCat||function(){};RTCat.Session=function(a){function b(a,b){return function(c){a.setLocalDescription(c),i.sendMessage("__offer",{sdp:c,to:b})}}function c(a){}function d(){i.onopen=function(){this.sendMessage("__join",{})},i.onmessage=function(a){var b=JSON.parse(a.data),c=b.eventName,d=b.data;k.emit(c,d)},i.onerror=function(a){k.emit("session-connect-fail",a),this.close()},i.sendMessage=function(a,b){this.send(JSON.stringify({eventName:a,data:b}))}}function e(a,b){var c={optional:[{RtpDataChannels:!0}]},d=new RTCat.PeerConnectioin(l,c);return m[a]=d,d.onicecandidate=function(b){b.candidate&&i.sendMessage("__ice",{label:b.candidate.sdpMLineIndex,candidate:b.candidate.candidate,to:a})},d.onaddstream=function(b){for(var c in n)c==a&&(k.remoteStreams[a].stream=b.stream,k.emit("stream-subscribed",k.remoteStreams[a]))},d.onnegotiationneeded=function(a){console.log(a)},b.stream&&d.addStream(b.stream),b.data&&f(d,a),d}function f(a,b){var c=a.createDataChannel("label");m[b].channel=c,h(c,b)}function g(a){var b=new RTCat.Stream;return b.init=null,b.id=a,b}function h(a,b){a.onopen=function(){k.emit("dataChannel-created",k.remoteStreams[b])},a.onclose=function(a){},a.onmessage=function(a){var c=JSON.parse(a.data);if("message"===c.type)k.emit("stream-message-received",b,c.content);else if("video"===c.type);else if("file"===c.type&&(k.remoteStreams[b][c.filename]=k.remoteStreams[b][c.filename]||[],k.remoteStreams[b][c.filename].push(c.content),c.last)){var d={blobUrl:k.remoteStreams[b][c.filename].join(""),name:c.filename};d.save=function(){var a=document.createElement("a");a.href=this.blobUrl,a.target="_blank",a.download=this.name||this.blobUrl;var b=document.createEvent("Event");b.initEvent("click",!0,!0),a.dispatchEvent(b),URL.revokeObjectURL(a.href)},k.emit("stream-file-received",b,d)}},a.onerror=function(a){k.emit("add-dataChannel-fail",error)}}var i,j,k=this,l={iceServers:[{url:"stun:api.realtimecat.com:3478"},{url:"stun:stun.anyfirewall.com:3478"},{credential:"homeo",username:"homeo",url:"turn:turn.bistri.com:80"},{credential:"webrtc",username:"webrtc",url:"turn:turn.anyfirewall.com:443?transport=tcp"}]},m={},n={},o=[];this.token=a,this.remoteStreams={},this.localStream={},this.connect=function(){var b="wss://api.realtimecat.com:3000/";i=new WebSocket(b,a),d()},this.publish=function(a){if(a.local){a.session=this,this.localStream=a;for(var d=0;d<o.length;d++){var f=e(o[d],a);k.remoteStreams[o[d]].pc=f,f.createOffer(b(f,o[d]),c)}}},this.subscribe=function(a,b){a.local||(n[a.id]=b)},this.unsubscribe=function(a){this.remoteStreams[a.id]&&(this.remoteStreams[a.id].showing&&this.remoteStreams[a.id].stop(),n[a.id]&&delete n[a.id],delete this.remoteStreams[a.id])},this.unpublish=function(a){if(a===this.localStream){for(var b in m)m[b].close();i.sendMessage("__unpublish",{})}},this.disconnect=function(){i.close()},this.on("_peers",function(a){o=a.connections,j=a.you;for(var b in o)k.remoteStreams[o[b]]=g(o[b]),k.remoteStreams[o[b]].data=!0;k.emit("session-connected",k.remoteStreams)}),this.on("_offer",function(a){var b=m[a.from];b.setRemoteDescription(new RTCat.SessionDescription(a.sdp)),b.createAnswer(function(c){b.setLocalDescription(c),i.sendMessage("__answer",{to:a.from,sdp:c})},function(a){console.log(a)})}),this.on("_answer",function(a){var b=m[a.from];b.setRemoteDescription(new RTCat.SessionDescription(a.sdp))}),this.on("_ice",function(a){var b=new RTCat.IceCandidate(a),c=m[a.from];if("complete"!=c.iceGatheringState)try{c.addIceCandidate(b)}catch(d){}}),this.on("_remove_peer",function(a){var b=m[a.socketId];b&&(b.close(),delete m[a.socketId]),k.emit("stream-removed",a.socketId)}),this.on("_join",function(a){o.push(a.socketId);var b=e(a.socketId,k.localStream),c=g(a.socketId);k.remoteStreams[a.socketId]=c,c.pc=b,c.data=k.localStream.data,k.emit("stream-added",c)}),this.on("_message",function(a){k.emit("session-message-received",a.from,a.message)}),this.sendMessageTo=function(a,b){i.sendMessage("__message",{message:a,socketId:b})},this["switch"]=function(a){if(k.renegotiating=!0,k.localStream)if(k.localStream.video==a.video)if(a.local){a.session=this,this.localStream=a;for(var d=0;d<k.remoteStreams;d++)k.remoteStreams[d].pc.removeStream(k.remoteStreams[d].stream),k.remoteStreams[d].pc.addStream(a.stream),k.remoteStreams[d].pc.createOffer(b(k.remoteStreams[d].pc,k.remoteStreams[d].id),c)}else k.emit("switch-error","Can not switch as remote stream");else k.emit("switch-error","Can not switch the same type stream");else k.emit("switch-error","Publish a localStream before switch")}},RTCat.Session.prototype=new RTCat.EventEmitter;var RTCat=RTCat||function(){};RTCat.Stream=function(a){function b(a){try{MediaStreamTrack?MediaStreamTrack.getSources(function(b){for(var c={},d=0;d<b.length;d++){var e=b[d];"audio"==e.kind&&(c.hasAudioDevice=!0),"video"==e.kind&&(c.hasVideoDevice=!0)}a(null,c)}):a("not supported")}catch(b){a(null,{hasAudioDevice:!0,hasVideoDevice:!0})}}function c(a){g.stream=a,g.emit("access-accepted")}function d(a){g.emit("access-failed",a)}function e(a,b,c){if(0==b.getVideoTracks().length){var d=document.createElement("audio");d.setAttribute("controls","controls")}else{var d=document.createElement("video");d.setAttribute("width",c.width),d.setAttribute("height",c.height)}d.src=RTCat.URL.createObjectURL(b);var e=document.querySelector("div#"+a);return e.appendChild(d),d.play(),d}function f(a,b){var c=new AudioContext,d=c.createAnalyser(),e=c.createMediaStreamSource(b),f=c.createScriptProcessor(2048,2,2),g=c.createGain();g.connect(c.destination),g.gain.value=.9,d.smoothingTimeConstant=.3,d.fftSize=1024,e.connect(d),d.connect(f),f.connect(c.destination),f.onaudioprocess=function(){var b=new Uint8Array(d.frequencyBinCount);d.getByteFrequencyData(b);for(var c=0,e=b.length,f=0;e>f;f++)f>100&&b[f]>100&&(a.volume=0),c+=b[f];a.volume=.9}}var g=this;this.newConfig={},this.showing=!1,this.init=function(){g.local=!0,a.data&&(g.data=!0),a.screen?RTCat.isMoz?g.emit("access-failed","The browser not supported screen sharing"):RTCat.extensionInstalled?(window.postMessage({type:"SS_UI_REQUEST",text:"start"},"*"),RTCat.localScreenStream=this):g.emit("access-failed","Please install extension"):b(function(b,e){b||(a.audio&&e.hasAudioDevice&&(g.newConfig.audio=!0),a.video&&e.hasVideoDevice&&(g.newConfig.video=!0)),g.newConfig.audio||g.newConfig.video?RTCat.GetUserMedia.call(navigator,g.newConfig,c,d):g.emit("access-accepted")})},this.hasAudio=function(){return this.local?this.newConfig.audio:this.stream?this.stream.getAudioTracks()?!0:void 0:!1},this.hasVideo=function(){return this.local?this.newConfig.video:this.stream?this.stream.getVideoTracks()?!0:void 0:!1},this.hasData=function(){return this.local?this.data:this.pc&&this.pc.channel?!0:!1},this.mute=function(){return this.local?void 0:this.player?this.player.muted=!0:!1},this.phonic=function(){return this.local?void 0:this.player?(this.player.muted=!1,!0):!1},this.close=function(){this.local&&this.session&&(this.stop(),this.session.unpublish(this))},this.play=function(a,b){if(!this.showing){this.showing=!0,this.elementId=a,b&&b.width&&b.height?parseInt(b.width)&&parseInt(b.height)||(b=b||{width:300,height:300}):b=b||{width:300,height:300};var c=e(a,this.stream,b);this.local?(c.volume=0,c.muted=0):window.AudioContext&&this.stream.getAudioTracks().length>0&&f(c,this.stream),this.player=c}},this.stop=function(){this.local||this.showing&&(this.showing=!1,this.player.remove())},this.sendMessage=function(a){if(!this.local&&this.data&&this.pc.channel&&"open"==this.pc.channel.readyState){var b={content:a,type:"message"};this.pc.channel.send(JSON.stringify(b))}},this.sendFile=function(a){if(!this.local&&this.data&&!this.file_sending&&(this.file_sending=!0,this.pc.channel)){var b,c=new FileReader;c.name=a.name,c.readAsDataURL(a),c.onReadAsDataURL=function(d,e){var f={type:"file",filename:c.name},h=1024;if(d&&(e=d.target.result,b=e.length),e.length>h){var i=(b-e.length)/b;g.emit("file-sending",a.name,i),f.content=e.slice(0,h)}else g.file_sending=!1,g.emit("file-sent",a.name),f.content=e,f.last=!0;g.pc.channel.send(JSON.stringify(f));var j=e.slice(f.content.length);console.log(j.length),j.length&&setTimeout(function(){c.onReadAsDataURL(null,j)},450)},c.onload=c.onReadAsDataURL}},this.getCapture=function(a,b,c,d,e){if(this.player&&(b&&parseFloat(b)||(b=0),c&&parseFloat(c)||(c=0),d&&parseFloat(d)||(d=this.player.width),e&&parseFloat(e)||(e=this.player.height),this.showing)){var f=a.getContext("2d");f.drawImage(this.player,b,c,d,e)}}},RTCat.Stream.prototype=new RTCat.EventEmitter;